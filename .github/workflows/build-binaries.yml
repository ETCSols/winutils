name: Build Hadoop Native Libraries for Windows

on:
  # Allow manual trigger with version selection
  workflow_dispatch:
    inputs:
      hadoop_versions:
        description: 'Hadoop versions to build (comma-separated, e.g., 3.3.6,3.4.1,3.4.2)'
        required: true
        default: '3.4.2'
  
  # # Trigger on push to main branch (optional)
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - '.github/workflows/build-hadoop-windows.yml'
  
  # # Scheduled builds (optional - runs monthly)
  # schedule:
  #   - cron: '0 0 1 * *'  # First day of every month

env:
  # Build configuration
  MAVEN_OPTS: '-Xms512m -Xmx2048m'
  JAVA_HOME_VAR: 'JAVA_HOME_11_X64'  # GitHub Actions Java 11 path variable

jobs:
  # Job to prepare the build matrix from input or default versions
  prepare-matrix:
    name: Prepare Build Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set Matrix Versions
        id: set-matrix
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Use input versions from manual trigger
            VERSIONS="${{ github.event.inputs.hadoop_versions }}"
          else
            # Default versions for scheduled or push events
            VERSIONS="3.3.6,3.4.1,3.4.2"
          fi
          
          # Convert comma-separated string to JSON array
          MATRIX=$(echo $VERSIONS | jq -R -c 'split(",") | map(gsub("^\\s+|\\s+$";""))')
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "Building Hadoop versions: $MATRIX"

  # Main build job with matrix strategy
  build-hadoop:
    name: Build Hadoop ${{ matrix.hadoop_version }}
    needs: prepare-matrix
    runs-on: windows-2022  # Using windows-2022 (windows-2019 retired as of 2025-06-30)
    strategy:
      fail-fast: false  # Continue other builds even if one fails
      matrix:
        hadoop_version: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
    
    steps:
      # ============================================
      # STEP 1: Checkout repository (for workflow tracking)
      # ============================================
      - name: Checkout Artifact Repository
        uses: actions/checkout@v4

      # ============================================
      # STEP 2: Setup Java Environment
      # ============================================
      - name: Setup Java JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Verify Java Installation
        shell: cmd
        run: |
          echo Verifying Java installation...
          java -version
          echo JAVA_HOME=%JAVA_HOME%

      # ============================================
      # STEP 3: Setup Maven
      # ============================================
      - name: Verify Maven Installation
        shell: cmd
        run: |
          echo Verifying Maven installation...
          mvn --version

      # ============================================
      # STEP 4: Setup CMake (required for native builds)
      # ============================================
      - name: Setup CMake
        uses: lukka/get-cmake@latest
        with:
          cmakeVersion: '3.28.0'

      - name: Verify CMake Installation
        shell: cmd
        run: |
          echo Verifying CMake installation...
          cmake --version

      # ============================================
      # STEP 5: Setup Protocol Buffers
      # ============================================
      - name: Setup Protocol Buffers 21.12
        shell: powershell
        run: |
          Write-Host "Installing Protocol Buffers 21.12..."
          
          # Protocol Buffers version (using new versioning scheme: v21.12 instead of v3.21.12)
          $PROTOBUF_VERSION = "21.12"
          $PROTOBUF_URL = "https://github.com/protocolbuffers/protobuf/releases/download/v$PROTOBUF_VERSION/protoc-$PROTOBUF_VERSION-win64.zip"
          
          # Create temp directory
          $TEMP_DIR = "$env:TEMP\protobuf"
          New-Item -ItemType Directory -Force -Path $TEMP_DIR | Out-Null
          
          # Download and extract
          $ZIP_FILE = "$TEMP_DIR\protoc.zip"
          Write-Host "Downloading from $PROTOBUF_URL..."
          Invoke-WebRequest -Uri $PROTOBUF_URL -OutFile $ZIP_FILE -UseBasicParsing
          
          # Extract to C:\protobuf
          $PROTOBUF_HOME = "C:\protobuf"
          Write-Host "Extracting to $PROTOBUF_HOME..."
          Expand-Archive -Path $ZIP_FILE -DestinationPath $PROTOBUF_HOME -Force
          
          # Add to PATH for subsequent steps
          echo "$PROTOBUF_HOME\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          
          Write-Host "Protocol Buffers installed successfully"

      - name: Verify Protocol Buffers Installation
        shell: cmd
        run: |
          echo Verifying Protocol Buffers installation...
          protoc --version

      # ============================================
      # STEP 6: Setup Boost (using vcpkg for Windows)
      # ============================================
      - name: Setup Boost 1.86.0
        shell: powershell
        run: |
          Write-Host "Installing Boost via vcpkg..."
          
          # vcpkg comes pre-installed on GitHub runners
          vcpkg install boost:x64-windows
          
          # Set BOOST_ROOT environment variable
          $BOOST_ROOT = "C:\vcpkg\installed\x64-windows"
          echo "BOOST_ROOT=$BOOST_ROOT" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          
          Write-Host "Boost installed successfully"

      # ============================================
      # STEP 7: Setup Zlib (required for compression)
      # ============================================
      - name: Setup Zlib
        shell: powershell
        run: |
          Write-Host "Installing Zlib via vcpkg..."
          
          vcpkg install zlib:x64-windows
          
          # Set ZLIB_HOME environment variable
          $ZLIB_HOME = "C:\vcpkg\installed\x64-windows"
          echo "ZLIB_HOME=$ZLIB_HOME" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          
          Write-Host "Zlib installed successfully"

      # ============================================
      # STEP 8: Setup Visual Studio Environment
      # ============================================
      - name: Setup Visual Studio Build Environment
        uses: microsoft/setup-msbuild@v2
        with:
          vs-version: '[17.0,18.0)'  # Visual Studio 2022
          
      - name: Setup Visual Studio Developer Command Prompt
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # ============================================
      # STEP 9: Set Platform Environment Variable
      # ============================================
      - name: Set Platform Environment Variable
        shell: cmd
        run: |
          echo Setting Platform environment variable for 64-bit build...
          echo Platform=x64>> %GITHUB_ENV%

      # ============================================
      # STEP 10: Clone Hadoop Repository
      # ============================================
      - name: Enable Git Long Paths
        shell: cmd
        run: |
          echo Enabling Git long path support for Windows...
          git config --global core.longpaths true
          
      - name: Clone Hadoop Repository
        shell: cmd
        run: |
          echo Cloning Apache Hadoop repository...
          git clone https://gitbox.apache.org/repos/asf/hadoop.git hadoop
          
      - name: Checkout Hadoop Version Tag
        shell: cmd
        working-directory: hadoop
        run: |
          echo Checking out Hadoop version ${{ matrix.hadoop_version }}...
          git fetch --tags
          git checkout rel/release-${{ matrix.hadoop_version }}
          
      - name: Verify Hadoop Source
        shell: cmd
        working-directory: hadoop
        run: |
          echo Verifying Hadoop source checkout...
          echo Current working directory:
          cd
          echo.
          echo Current branch/tag:
          git describe --tags
          echo.
          echo Latest commit:
          git log -1 --oneline
          echo.
          echo Source directory contents:
          dir

      # ============================================
      # STEP 11: Cache Maven Dependencies
      # ============================================
      - name: Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ runner.os }}-${{ matrix.hadoop_version }}-${{ hashFiles('hadoop/**/pom.xml') }}
          restore-keys: |
            maven-${{ runner.os }}-${{ matrix.hadoop_version }}-
            maven-${{ runner.os }}-

      # ============================================
      # STEP 12: Build Hadoop Native Libraries
      # ============================================
      - name: Build Hadoop Common Native Libraries
        shell: cmd
        working-directory: hadoop
        run: |
          echo ================================================
          echo Building Hadoop ${{ matrix.hadoop_version }} Native Libraries
          echo ================================================
          echo Current directory: %CD%
          echo.
          
          REM Set required environment variables
          set JAVA_HOME=%JAVA_HOME%
          set PATH=%PATH%;C:\protobuf\bin
          
          REM Display environment for debugging
          echo Environment Variables:
          echo JAVA_HOME=%JAVA_HOME%
          echo MAVEN_OPTS=%MAVEN_OPTS%
          echo Platform=%Platform%
          echo.
          
          REM Verify tools are available
          echo Verifying build tools...
          java -version
          echo.
          mvn --version
          echo.
          cmake --version
          echo.
          protoc --version
          echo.
          
          REM Build ONLY hadoop-common-project with native libraries
          REM This avoids the hadoop-project-dist module which requires WSL
          REM The native binaries (winutils.exe, hadoop.dll) are in hadoop-common
          
          echo Building hadoop-common-project with native libraries...
          cd hadoop-common-project
          
          mvn clean package -Pnative-win -DskipTests -Dmaven.javadoc.skip=true
          
          echo.
          echo Build completed. Checking for native binaries...
        timeout-minutes: 60

      # ============================================
      # STEP 13: Verify Build Artifacts
      # ============================================
      - name: Verify Native Binaries
        shell: powershell
        working-directory: hadoop
        run: |
          Write-Host "Verifying native binaries were built..."
          
          # Search for the native binaries in hadoop-common
          $NATIVE_PATH = "hadoop-common-project\hadoop-common\target\native\target\bin"
          
          Write-Host "Checking binaries in: $NATIVE_PATH"
          Write-Host "Full path: $((Get-Location).Path)\$NATIVE_PATH"
          
          # Check for critical native files
          $REQUIRED_FILES = @(
            "winutils.exe",
            "hadoop.dll"
          )
          
          $OPTIONAL_FILES = @(
            "hadoop.exp",
            "hadoop.lib",
            "hadoop.pdb"
          )
          
          $ALL_FOUND = $true
          Write-Host "`nRequired Files:"
          foreach ($FILE in $REQUIRED_FILES) {
            $FILE_PATH = Join-Path $NATIVE_PATH $FILE
            if (Test-Path $FILE_PATH) {
              $FILE_SIZE = (Get-Item $FILE_PATH).Length
              Write-Host "  ✓ Found: $FILE ($FILE_SIZE bytes)"
            } else {
              Write-Host "  ✗ Missing: $FILE"
              $ALL_FOUND = $false
            }
          }
          
          Write-Host "`nOptional Files:"
          foreach ($FILE in $OPTIONAL_FILES) {
            $FILE_PATH = Join-Path $NATIVE_PATH $FILE
            if (Test-Path $FILE_PATH) {
              $FILE_SIZE = (Get-Item $FILE_PATH).Length
              Write-Host "  ✓ Found: $FILE ($FILE_SIZE bytes)"
            } else {
              Write-Host "  - Not found: $FILE (optional)"
            }
          }
          
          if (-not $ALL_FOUND) {
            Write-Host "`nError: Some required binaries were not built!"
            Write-Host "`nSearching for native binaries in target directories..."
            Get-ChildItem -Path "hadoop-common-project" -Recurse -Filter "*.dll" -ErrorAction SilentlyContinue | ForEach-Object {
              Write-Host "  Found DLL: $($_.FullName)"
            }
            Get-ChildItem -Path "hadoop-common-project" -Recurse -Filter "winutils.exe" -ErrorAction SilentlyContinue | ForEach-Object {
              Write-Host "  Found EXE: $($_.FullName)"
            }
            exit 1
          }
          
          Write-Host "`nAll required native binaries found successfully!"
          
          # List all files in the native bin directory
          Write-Host "`nAll files in native bin directory:"
          Get-ChildItem -Path $NATIVE_PATH | ForEach-Object {
            Write-Host "  - $($_.Name) ($($_.Length) bytes)"
          }

      # ============================================
      # STEP 14: Prepare Artifacts for Upload
      # ============================================
      - name: Prepare Artifacts
        shell: powershell
        working-directory: hadoop
        run: |
          Write-Host "Preparing artifacts for upload..."
          
          $HADOOP_VERSION = "${{ matrix.hadoop_version }}"
          $BIN_PATH = "hadoop-common-project\hadoop-common\target\native\target\bin"
          $ARTIFACT_DIR = "..\hadoop-artifacts\hadoop-$HADOOP_VERSION-native-win"
          
          Write-Host "Source path: $((Get-Location).Path)\$BIN_PATH"
          Write-Host "Destination path: $((Get-Location).Path)\$ARTIFACT_DIR"
          
          # Create artifact directory
          New-Item -ItemType Directory -Force -Path $ARTIFACT_DIR | Out-Null
          
          # Copy native binaries
          Write-Host "`nCopying native binaries..."
          Copy-Item -Path "$BIN_PATH\*" -Destination $ARTIFACT_DIR -Force
          
          # Create build info file
          $BUILD_INFO = @"
          Hadoop Version: $HADOOP_VERSION
          Build Date: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
          Build Type: Native Windows Libraries Only
          Build OS: Windows Server 2022
          Build Runner: GitHub Actions
          Java Version: $(java -version 2>&1 | Select-Object -First 1)
          Maven Version: $(mvn --version | Select-Object -First 1)
          CMake Version: $(cmake --version | Select-Object -First 1)
          Protobuf Version: $(protoc --version)
          
          Build Notes:
          - These are ONLY the native Windows binaries (winutils.exe, hadoop.dll, etc.)
          - Built from hadoop-common-project module
          - Does not include Java JARs or full Hadoop distribution
          - Compatible with official Hadoop $HADOOP_VERSION distribution
          
          Usage:
          1. Download your Hadoop $HADOOP_VERSION distribution from Apache
          2. Extract these native binaries to your HADOOP_HOME\bin directory
          3. Set HADOOP_HOME environment variable
          4. Verify with: hadoop checknative -a
          
          Files Included:
          "@ | Out-File -FilePath "$ARTIFACT_DIR\BUILD_INFO.txt" -Encoding UTF8
          
          # List all files
          Get-ChildItem -Path $ARTIFACT_DIR | ForEach-Object {
            Add-Content -Path "$ARTIFACT_DIR\BUILD_INFO.txt" -Value "  - $($_.Name) ($($_.Length) bytes)"
          }
          
          Write-Host "`nArtifacts prepared successfully!"
          Write-Host "`nContents of artifact directory:"
          Get-ChildItem -Path $ARTIFACT_DIR | ForEach-Object {
            Write-Host "  - $($_.Name) ($($_.Length) bytes)"
          }

      # ============================================
      # STEP 15: Upload Native Binaries as Artifacts
      # ============================================
      - name: Upload Native Binaries
        uses: actions/upload-artifact@v4
        with:
          name: hadoop-${{ matrix.hadoop_version }}-native-windows-x64
          path: hadoop-artifacts/hadoop-${{ matrix.hadoop_version }}-native-win/
          if-no-files-found: error
          retention-days: 90
          compression-level: 9

      # ============================================
      # STEP 16: Upload Build Logs (on failure)
      # ============================================
      - name: Upload Build Logs on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.hadoop_version }}-${{ github.run_number }}
          path: |
            hadoop/hadoop-common-project/**/*.log
            hadoop/hadoop-common-project/**/target/surefire-reports/
          if-no-files-found: warn
          retention-days: 30

  # ============================================
  # Summary Job (runs after all builds complete)
  # ============================================
  build-summary:
    name: Build Summary
    needs: [prepare-matrix, build-hadoop]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate Build Summary
        run: |
          echo "# Hadoop Windows Native Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## What Was Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow builds **only the native Windows binaries** from Hadoop:" >> $GITHUB_STEP_SUMMARY
          echo "- \`winutils.exe\` - Hadoop Windows utilities" >> $GITHUB_STEP_SUMMARY
          echo "- \`hadoop.dll\` - Native Hadoop library" >> $GITHUB_STEP_SUMMARY
          echo "- Supporting files (\`.lib\`, \`.pdb\`, \`.exp\`)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "These binaries are built from the \`hadoop-common-project\` module only." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Hadoop Version | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Multiple versions | Check individual job logs |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Native Windows binaries have been uploaded as workflow artifacts." >> $GITHUB_STEP_SUMMARY
          echo "Download them from the [Actions artifacts section](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Usage Instructions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the official Hadoop distribution for your version from [Apache Hadoop](https://hadoop.apache.org/releases.html)" >> $GITHUB_STEP_SUMMARY
          echo "2. Download the native binaries artifact for your version from this workflow" >> $GITHUB_STEP_SUMMARY
          echo "3. Extract the native binaries to \`HADOOP_HOME\\bin\` directory" >> $GITHUB_STEP_SUMMARY
          echo "4. Set \`HADOOP_HOME\` environment variable to your Hadoop installation directory" >> $GITHUB_STEP_SUMMARY
          echo "5. Add \`%HADOOP_HOME%\\bin\` to your system PATH" >> $GITHUB_STEP_SUMMARY
          echo "6. Verify with: \`hadoop checknative -a\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Why Only Native Binaries?" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Building the full Hadoop distribution on Windows requires WSL (Windows Subsystem for Linux)," >> $GITHUB_STEP_SUMMARY
          echo "which is not available in GitHub Actions runners. Since the native binaries are the main" >> $GITHUB_STEP_SUMMARY
          echo "components missing from the official distributions, we build only those components." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The native binaries are fully compatible with the official Hadoop distributions." >> $GITHUB_STEP_SUMMARY
