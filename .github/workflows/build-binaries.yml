name: Build Hadoop Native Libraries for Windows

on:
  # Allow manual trigger with version selection
  workflow_dispatch:
    inputs:
      hadoop_versions:
        description: 'Hadoop versions to build (comma-separated, e.g., 3.3.6,3.4.1,3.4.2)'
        required: true
        default: '3.4.2'
  
  # # Trigger on push to main branch (optional)
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - '.github/workflows/build-hadoop-windows.yml'
  
  # # Scheduled builds (optional - runs monthly)
  # schedule:
  #   - cron: '0 0 1 * *'  # First day of every month

env:
  # Build configuration
  MAVEN_OPTS: '-Xms512m -Xmx2048m'
  JAVA_HOME_VAR: 'JAVA_HOME_11_X64'  # GitHub Actions Java 11 path variable

jobs:
  # Job to prepare the build matrix from input or default versions
  prepare-matrix:
    name: Prepare Build Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set Matrix Versions
        id: set-matrix
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Use input versions from manual trigger
            VERSIONS="${{ github.event.inputs.hadoop_versions }}"
          else
            # Default versions for scheduled or push events
            VERSIONS="3.3.6,3.4.1,3.4.2"
          fi
          
          # Convert comma-separated string to JSON array
          MATRIX=$(echo $VERSIONS | jq -R -c 'split(",") | map(gsub("^\\s+|\\s+$";""))')
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "Building Hadoop versions: $MATRIX"

  # Main build job with matrix strategy
  build-hadoop:
    name: Build Hadoop ${{ matrix.hadoop_version }}
    needs: prepare-matrix
    runs-on: windows-2022  # Using windows-2022 (windows-2019 retired as of 2025-06-30)
    strategy:
      fail-fast: false  # Continue other builds even if one fails
      matrix:
        hadoop_version: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
    
    steps:
      # ============================================
      # STEP 1: Checkout repository (for workflow tracking)
      # ============================================
      - name: Checkout Artifact Repository
        uses: actions/checkout@v4

      # ============================================
      # STEP 2: Setup Java Environment
      # ============================================
      - name: Setup Java JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Verify Java Installation
        shell: cmd
        run: |
          echo Verifying Java installation...
          java -version
          echo JAVA_HOME=%JAVA_HOME%

      # ============================================
      # STEP 3: Setup Maven
      # ============================================
      - name: Verify Maven Installation
        shell: cmd
        run: |
          echo Verifying Maven installation...
          mvn --version

      # ============================================
      # STEP 4: Setup CMake (required for native builds)
      # ============================================
      - name: Setup CMake
        uses: lukka/get-cmake@latest
        with:
          cmakeVersion: '3.28.0'

      - name: Verify CMake Installation
        shell: cmd
        run: |
          echo Verifying CMake installation...
          cmake --version

      # ============================================
      # STEP 5: Setup Protocol Buffers
      # ============================================
      - name: Setup Protocol Buffers 21.12
        shell: powershell
        run: |
          Write-Host "Installing Protocol Buffers 21.12..."
          
          # Protocol Buffers version (using new versioning scheme: v21.12 instead of v3.21.12)
          $PROTOBUF_VERSION = "21.12"
          $PROTOBUF_URL = "https://github.com/protocolbuffers/protobuf/releases/download/v$PROTOBUF_VERSION/protoc-$PROTOBUF_VERSION-win64.zip"
          
          # Create temp directory
          $TEMP_DIR = "$env:TEMP\protobuf"
          New-Item -ItemType Directory -Force -Path $TEMP_DIR | Out-Null
          
          # Download and extract
          $ZIP_FILE = "$TEMP_DIR\protoc.zip"
          Write-Host "Downloading from $PROTOBUF_URL..."
          Invoke-WebRequest -Uri $PROTOBUF_URL -OutFile $ZIP_FILE -UseBasicParsing
          
          # Extract to C:\protobuf
          $PROTOBUF_HOME = "C:\protobuf"
          Write-Host "Extracting to $PROTOBUF_HOME..."
          Expand-Archive -Path $ZIP_FILE -DestinationPath $PROTOBUF_HOME -Force
          
          # Add to PATH for subsequent steps
          echo "$PROTOBUF_HOME\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          
          Write-Host "Protocol Buffers installed successfully"

      - name: Verify Protocol Buffers Installation
        shell: cmd
        run: |
          echo Verifying Protocol Buffers installation...
          protoc --version

      # ============================================
      # STEP 6: Setup Boost (using vcpkg for Windows)
      # ============================================
      - name: Cache vcpkg packages
        uses: actions/cache@v4
        id: vcpkg-cache
        with:
          path: |
            C:\vcpkg\installed
            C:\vcpkg\packages
            C:\vcpkg\buildtrees
          key: vcpkg-${{ runner.os }}-boost-zlib-${{ hashFiles('**/vcpkg.json') }}
          restore-keys: |
            vcpkg-${{ runner.os }}-boost-zlib-
            vcpkg-${{ runner.os }}-
      
      - name: Setup Boost (if needed)
        if: steps.vcpkg-cache.outputs.cache-hit != 'true'
        shell: powershell
        run: |
          Write-Host "Installing Boost via vcpkg (this may take 20-30 minutes first time)..."
          Write-Host "Future runs will use cached version."
          
          # vcpkg comes pre-installed on GitHub runners
          vcpkg install boost:x64-windows
          
          Write-Host "Boost installed successfully"
      
      - name: Configure Boost Environment
        shell: powershell
        run: |
          # Set BOOST_ROOT environment variable
          $BOOST_ROOT = "C:\vcpkg\installed\x64-windows"
          echo "BOOST_ROOT=$BOOST_ROOT" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          
          Write-Host "Boost environment configured"
          Write-Host "BOOST_ROOT: $BOOST_ROOT"

      # ============================================
      # STEP 7: Setup Zlib (required for compression)
      # ============================================
      - name: Setup Zlib
        if: steps.vcpkg-cache.outputs.cache-hit != 'true'
        shell: powershell
        run: |
          Write-Host "Installing Zlib via vcpkg..."
          
          vcpkg install zlib:x64-windows
          
          Write-Host "Zlib installed successfully"
      
      - name: Configure Zlib Environment
        shell: powershell
        run: |
          # Set ZLIB_HOME environment variable
          $ZLIB_HOME = "C:\vcpkg\installed\x64-windows"
          echo "ZLIB_HOME=$ZLIB_HOME" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          
          Write-Host "Zlib environment configured"
          Write-Host "ZLIB_HOME: $ZLIB_HOME"

      # ============================================
      # STEP 8: Setup Visual Studio Environment
      # ============================================
      - name: Setup Visual Studio Build Environment
        uses: microsoft/setup-msbuild@v2
        with:
          vs-version: '[17.0,18.0)'  # Visual Studio 2022
          
      - name: Setup Visual Studio Developer Command Prompt
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # ============================================
      # STEP 9: Set Platform Environment Variable
      # ============================================
      - name: Set Platform Environment Variable
        shell: cmd
        run: |
          echo Setting Platform environment variable for 64-bit build...
          echo Platform=x64>> %GITHUB_ENV%

      # ============================================
      # STEP 10: Clone Hadoop Repository
      # ============================================
      - name: Enable Git Long Paths
        shell: cmd
        run: |
          echo Enabling Git long path support for Windows...
          git config --global core.longpaths true
          
      - name: Clone Hadoop Repository
        shell: cmd
        run: |
          echo Cloning Apache Hadoop repository...
          git clone https://gitbox.apache.org/repos/asf/hadoop.git hadoop
          
      - name: Checkout Hadoop Version Tag
        shell: cmd
        working-directory: hadoop
        run: |
          echo Checking out Hadoop version ${{ matrix.hadoop_version }}...
          git fetch --tags
          git checkout rel/release-${{ matrix.hadoop_version }}
          
      - name: Verify Hadoop Source
        shell: cmd
        working-directory: hadoop
        run: |
          echo Verifying Hadoop source checkout...
          echo Current working directory:
          cd
          echo.
          echo Current branch/tag:
          git describe --tags
          echo.
          echo Latest commit:
          git log -1 --oneline
          echo.
          echo Source directory contents:
          dir

      # ============================================
      # STEP 11A: Verify Maven Profile Configuration
      # ============================================
      - name: Check Maven Native Profile
        shell: cmd
        working-directory: hadoop\hadoop-common-project\hadoop-common
        run: |
          echo ================================================
          echo Checking Maven Profile Configuration
          echo ================================================
          
          echo Listing available Maven profiles...
          mvn help:all-profiles
          
          echo.
          echo Checking if native-win profile exists...
          mvn help:active-profiles -Pnative-win
          
          echo.
          echo Checking effective POM with native-win profile...
          mvn help:effective-pom -Pnative-win > effective-pom.xml
          
          echo.
          echo Searching for native build configuration in effective POM...
          findstr /I /C:"native" /C:"cmake" /C:"make" effective-pom.xml
          
          echo.
          echo Checking what Maven will execute with native-win profile...
          mvn compile -Pnative-win -DskipTests -X -Dmaven.javadoc.skip=true 2>&1 | findstr /I /C:"native" /C:"cmake" /C:"exec" /C:"BUILD SUCCESS" /C:"BUILD FAILURE"

      # ============================================
      # STEP 11B: Patch Hadoop Source for Windows SDK Compatibility
      # ============================================
      - name: Patch Hadoop Source for Modern Windows SDK
        shell: powershell
        working-directory: hadoop\hadoop-common-project\hadoop-common
        run: |
          Write-Host "Patching Hadoop source for Windows SDK 10.0.26100.0 compatibility..."
          
          $WINUTILS_HEADER = "src\main\winutils\include\winutils.h"
          
          if (Test-Path $WINUTILS_HEADER) {
            Write-Host "Found winutils.h at: $WINUTILS_HEADER"
            Write-Host ""
            
            # Read the file content
            $content = Get-Content $WINUTILS_HEADER -Raw
            
            Write-Host "Checking for GetFileInformationByName declaration..."
            
            # Show the problematic lines
            $lines = Get-Content $WINUTILS_HEADER
            for ($i = 0; $i -lt $lines.Count; $i++) {
              if ($lines[$i] -match "GetFileInformationByName") {
                Write-Host "Found at line $($i+1): $($lines[$i])"
              }
            }
            
            Write-Host ""
            Write-Host "Applying compatibility fix..."
            
            # Strategy: Wrap the declaration in an #ifndef guard
            # This prevents redefinition if Windows SDK already provides it
            
            # Pattern to match the entire GetFileInformationByName declaration
            # It might span multiple lines, so we need to handle that
            $pattern = '(?s)(BOOL\s+WINAPI\s+GetFileInformationByName\s*\([^)]+\)\s*;)'
            
            if ($content -match $pattern) {
              Write-Host "Found GetFileInformationByName declaration"
              
              # Replace with guarded version
              $replacement = @"
              #ifndef GetFileInformationByName
              // Conditionally declare GetFileInformationByName for older Windows SDK versions
              // Modern Windows SDK (10.0.26100.0+) already provides this function
              $($matches[1])
              #endif
              "@
              
              $content = $content -replace $pattern, $replacement
              
              # Write back with UTF8 encoding
              [System.IO.File]::WriteAllText($WINUTILS_HEADER, $content, [System.Text.Encoding]::UTF8)
              
              Write-Host "Patch applied successfully!"
            } else {
              Write-Host "Could not match GetFileInformationByName pattern with regex"
              Write-Host "Trying line-by-line approach..."
              
              # Alternative: Line-by-line approach
              $lines = Get-Content $WINUTILS_HEADER
              $newLines = @()
              $inDeclaration = $false
              $declarationLines = @()
              
              for ($i = 0; $i -lt $lines.Count; $i++) {
                $line = $lines[$i]
                
                # Check if this line starts the GetFileInformationByName declaration
                if ($line -match 'BOOL\s+WINAPI\s+GetFileInformationByName') {
                  $inDeclaration = $true
                  $declarationLines = @()
                  $newLines += "#ifndef GetFileInformationByName"
                  $newLines += "// Conditionally declare GetFileInformationByName for older Windows SDK"
                  $declarationLines += $line
                  
                  # Check if declaration ends on same line
                  if ($line -match ';') {
                    $inDeclaration = $false
                    $newLines += $declarationLines
                    $newLines += "#endif"
                    $declarationLines = @()
                  }
                }
                elseif ($inDeclaration) {
                  $declarationLines += $line
                  if ($line -match ';') {
                    $inDeclaration = $false
                    $newLines += $declarationLines
                    $newLines += "#endif"
                    $declarationLines = @()
                  }
                }
                else {
                  $newLines += $line
                }
              }
              
              # Write the modified content
              $newContent = $newLines -join "`r`n"
              [System.IO.File]::WriteAllText($WINUTILS_HEADER, $newContent, [System.Text.Encoding]::UTF8)
              
              Write-Host "Line-by-line patch applied!"
            }
            
            Write-Host ""
            Write-Host "Verifying patch..."
            Write-Host ""
            Get-Content $WINUTILS_HEADER | Select-String -Pattern "GetFileInformationByName" -Context 3
            
          } else {
            Write-Host "ERROR: winutils.h not found at: $WINUTILS_HEADER"
            Write-Host "Searching for winutils.h..."
            Get-ChildItem -Path "src" -Recurse -Filter "winutils.h" -ErrorAction SilentlyContinue | ForEach-Object {
              Write-Host "  Found: $($_.FullName)"
            }
            exit 1
          }
          
          Write-Host ""
          Write-Host "Patch complete!"

      # ============================================
      # STEP 11C: Cache Maven Dependencies
      # ============================================
      - name: Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ runner.os }}-${{ matrix.hadoop_version }}-${{ hashFiles('hadoop/**/pom.xml') }}
          restore-keys: |
            maven-${{ runner.os }}-${{ matrix.hadoop_version }}-
            maven-${{ runner.os }}-

      # ============================================
      # STEP 12: Build Hadoop Native Libraries
      # ============================================
      - name: Try Alternative Native Build Method
        shell: cmd
        working-directory: hadoop\hadoop-common-project\hadoop-common
        run: |
          echo ================================================
          echo Attempting Native Build - Method 1: Direct Maven Profile
          echo ================================================
          
          REM Set all required environment variables
          set JAVA_HOME=%JAVA_HOME%
          set PATH=%PATH%;C:\protobuf\bin
          set Platform=x64
          set REQUIRE_SNAPPY=false
          set REQUIRE_OPENSSL=false
          set REQUIRE_BZIP2=false
          
          echo Current directory: %CD%
          echo.
          
          REM First, check what profiles are available
          echo Checking available Maven profiles...
          mvn help:all-profiles | findstr /I "native win"
          echo.
          
          REM Try Method 1: Standard native-win profile
          echo Attempting: mvn package -Pnative-win -DskipTests
          mvn clean package -Pnative-win -DskipTests -Dmaven.javadoc.skip=true -Drequire.snappy=false -Drequire.openssl=false
          
          if exist target\native (
            echo [SUCCESS] Method 1 worked! Native directory created.
            goto :build_complete
          )
          
          echo [INFO] Method 1 did not create native directory. Trying Method 2...
          echo.
          
          :method2
          echo ================================================
          echo Attempting Native Build - Method 2: Explicit Native Flag
          echo ================================================
          
          REM Try Method 2: Using -Dnative property
          echo Attempting: mvn package -Dnative=true
          mvn clean package -Dnative=true -DskipTests -Dmaven.javadoc.skip=true
          
          if exist target\native (
            echo [SUCCESS] Method 2 worked! Native directory created.
            goto :build_complete
          )
          
          echo [INFO] Method 2 did not create native directory. Trying Method 3...
          echo.
          
          :method3
          echo ================================================
          echo Attempting Native Build - Method 3: Direct Native Module
          echo ================================================
          
          REM Check if there's a separate native source directory
          if exist src\main\native (
            echo Native source directory found: src\main\native
            cd src\main\native
            
            REM Try building with CMake directly
            if exist CMakeLists.txt (
              echo [INFO] Found CMakeLists.txt, attempting direct CMake build...
              
              mkdir build 2>nul
              cd build
              
              echo Running CMake configuration...
              cmake -G "Visual Studio 17 2022" -A x64 ..
              
              if errorlevel 1 (
                echo [ERROR] CMake configuration failed
                cd ..\..\..\
                goto :method4
              )
              
              echo Running CMake build...
              cmake --build . --config Release
              
              if errorlevel 1 (
                echo [ERROR] CMake build failed
                cd ..\..\..\
                goto :method4
              )
              
              echo [SUCCESS] Method 3 worked! CMake build completed.
              
              REM Copy binaries to expected location
              cd ..\..\..\
              mkdir target\native\target\bin 2>nul
              
              if exist src\main\native\build\Release\*.exe (
                copy src\main\native\build\Release\*.exe target\native\target\bin\
              )
              if exist src\main\native\build\Release\*.dll (
                copy src\main\native\build\Release\*.dll target\native\target\bin\
              )
              if exist src\main\native\build\Release\*.lib (
                copy src\main\native\build\Release\*.lib target\native\target\bin\
              )
              
              goto :build_complete
            ) else (
              echo [INFO] No CMakeLists.txt in src\main\native
              cd ..\..\..
            )
          )
          
          :method4
          echo ================================================
          echo Attempting Native Build - Method 4: Maven Compile Phase Only
          echo ================================================
          
          REM Try Method 4: Just compile phase with native profile
          echo Attempting: mvn compile -Pnative-win
          mvn compile -Pnative-win -DskipTests
          
          if exist target\native (
            echo [SUCCESS] Method 4 worked! Native directory created.
            
            REM Now package the rest
            echo Running package phase...
            mvn package -Pnative-win -DskipTests -Dmaven.javadoc.skip=true
            goto :build_complete
          )
          
          echo [ERROR] All build methods failed. Native compilation did not occur.
          echo.
          echo This could mean:
          echo 1. The native-win profile does not exist in this Hadoop version
          echo 2. The profile exists but is not configured for Windows
          echo 3. Additional dependencies or configuration are required
          echo.
          echo Searching for pom.xml profile definitions...
          findstr /I /C:"<id>native" pom.xml
          echo.
          exit /b 1
          
          :build_complete
          echo.
          echo ================================================
          echo Native build completed successfully!
          echo ================================================
          echo.
          
          echo Examining build output...
          if exist target\native (
            echo Native directory structure:
            dir /s target\native
          ) else (
            echo WARNING: target\native still does not exist after successful build
            echo Searching for binaries in target directory...
            dir /s /b target\*.exe target\*.dll
          )
        timeout-minutes: 60
        continue-on-error: false

      # ============================================
      # STEP 13: Verify Build Artifacts
      # ============================================
      - name: Check Build Logs for Native Compilation
        shell: powershell
        working-directory: hadoop
        run: |
          Write-Host "Checking if native compilation was attempted..."
          
          # Look for CMake execution in recent files
          Write-Host ""
          Write-Host "Searching for CMake-related files..."
          Get-ChildItem -Path "hadoop-common-project\hadoop-common" -Recurse -Filter "CMakeCache.txt" -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Host "  Found: $($_.FullName)"
          }
          
          Write-Host ""
          Write-Host "Searching for build directories..."
          Get-ChildItem -Path "hadoop-common-project\hadoop-common\target" -Directory -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Host "  - $($_.Name)"
          }
          
          Write-Host ""
          Write-Host "Checking for any compiled files..."
          Get-ChildItem -Path "hadoop-common-project\hadoop-common\target" -Recurse -Include "*.exe","*.dll","*.lib" -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Host "  Found: $($_.FullName) ($($_.Length) bytes)"
          }
          
      - name: Verify Native Binaries
        shell: powershell
        working-directory: hadoop
        run: |
          Write-Host "Verifying native binaries were built..."
          
          # Try multiple possible locations
          $POSSIBLE_PATHS = @(
            "hadoop-common-project\hadoop-common\target\native\target\bin",
            "hadoop-common-project\hadoop-common\target\bin",
            "hadoop-common-project\hadoop-common\src\main\native\target\bin",
            "hadoop-common-project\hadoop-common\target\native\bin"
          )
          
          $NATIVE_PATH = $null
          foreach ($path in $POSSIBLE_PATHS) {
            if (Test-Path $path) {
              $NATIVE_PATH = $path
              Write-Host "Found native bin directory at: $path"
              break
            }
          }
          
          if (-not $NATIVE_PATH) {
            Write-Host ""
            Write-Host "ERROR: Could not find native bin directory in any expected location!"
            Write-Host ""
            Write-Host "Searched locations:"
            foreach ($path in $POSSIBLE_PATHS) {
              Write-Host "  - $path"
            }
            
            Write-Host ""
            Write-Host "Available directories in target:"
            Get-ChildItem -Path "hadoop-common-project\hadoop-common\target" -Directory -ErrorAction SilentlyContinue | ForEach-Object {
              Write-Host "  - target\$($_.Name)"
            }
            
            exit 1
          }
          
          Write-Host "Checking binaries in: $NATIVE_PATH"
          Write-Host "Full path: $((Get-Location).Path)\$NATIVE_PATH"
          
          $REQUIRED_FILES = @(
            "winutils.exe",
            "winutils.pdb",
            "hadoop.dll",
            "hadoop.exp",
            "hadoop.lib",
            "hadoop.pdb",
            "hadoop.cmd",
            "libwinutils.lib",
            "libwinutils.pdb"
          )
          
          $OPTIONAL_FILES = @(
            "hdfs.dll",
            "hdfs.exp",
            "hdfs.lib",
            "hdfs.pdb",
            "hdfs.cmd",
            "mapred.cmd",
            "yarn.cmd",
            "hdfs",
            "mapred",
            "yarn",
            "hadoop",
            "gmock.pdb",
            "gmock_main.pdb",
            "gtest.pdb",
            "gtest_main.pdb"
          )
          
          $ALL_FOUND = $true
          $FOUND_COUNT = 0
          
          Write-Host ""
          Write-Host "=== CRITICAL NATIVE FILES ==="
          foreach ($FILE in $REQUIRED_FILES) {
            $FILE_PATH = Join-Path $NATIVE_PATH $FILE
            if (Test-Path $FILE_PATH) {
              $FILE_SIZE = (Get-Item $FILE_PATH).Length
              Write-Host "  [OK] Found: $FILE ($FILE_SIZE bytes)"
              $FOUND_COUNT++
            } else {
              Write-Host "  [MISSING] $FILE"
              $ALL_FOUND = $false
            }
          }
          
          Write-Host ""
          Write-Host "=== OPTIONAL/ADDITIONAL FILES ==="
          foreach ($FILE in $OPTIONAL_FILES) {
            $FILE_PATH = Join-Path $NATIVE_PATH $FILE
            if (Test-Path $FILE_PATH) {
              $FILE_SIZE = (Get-Item $FILE_PATH).Length
              Write-Host "  [OK] Found: $FILE ($FILE_SIZE bytes)"
              $FOUND_COUNT++
            } else {
              Write-Host "  [SKIP] Not found: $FILE (optional)"
            }
          }
          
          if (-not $ALL_FOUND) {
            Write-Host ""
            Write-Host "ERROR: Some REQUIRED binaries were not built!"
            Write-Host ""
            Write-Host "Searching entire target directory for native binaries..."
            
            Write-Host ""
            Write-Host "DLL files found:"
            Get-ChildItem -Path "hadoop-common-project" -Recurse -Filter "*.dll" -ErrorAction SilentlyContinue | ForEach-Object {
              Write-Host "  - $($_.FullName)"
            }
            
            Write-Host ""
            Write-Host "EXE files found:"
            Get-ChildItem -Path "hadoop-common-project" -Recurse -Filter "*.exe" -ErrorAction SilentlyContinue | ForEach-Object {
              Write-Host "  - $($_.FullName)"
            }
            
            Write-Host ""
            Write-Host "LIB files found:"
            Get-ChildItem -Path "hadoop-common-project" -Recurse -Filter "*.lib" -ErrorAction SilentlyContinue | ForEach-Object {
              Write-Host "  - $($_.FullName)"
            }
            
            exit 1
          }
          
          Write-Host ""
          Write-Host "SUCCESS: All REQUIRED native binaries found!"
          Write-Host "Total files found: $FOUND_COUNT"
          
          Write-Host ""
          Write-Host "=== ALL FILES IN NATIVE BIN DIRECTORY ==="
          Get-ChildItem -Path $NATIVE_PATH | Sort-Object Name | ForEach-Object {
            $size = if ($_.Length -lt 1KB) { 
              "$($_.Length) bytes" 
            } elseif ($_.Length -lt 1MB) { 
              "{0:N2} KB" -f ($_.Length / 1KB) 
            } else { 
              "{0:N2} MB" -f ($_.Length / 1MB) 
            }
            Write-Host "  - $($_.Name) ($size)"
          }

      # ============================================
      # STEP 14: Prepare Artifacts for Upload
      # ============================================
      - name: Prepare Artifacts
        shell: powershell
        working-directory: hadoop
        run: |
          Write-Host "Preparing artifacts for upload..."
          
          $HADOOP_VERSION = "${{ matrix.hadoop_version }}"
          $BIN_PATH = "hadoop-common-project\hadoop-common\target\native\target\bin"
          $ARTIFACT_DIR = "..\hadoop-artifacts\hadoop-$HADOOP_VERSION-native-win"
          
          Write-Host "Source path: $((Get-Location).Path)\$BIN_PATH"
          Write-Host "Destination path: $((Get-Location).Path)\$ARTIFACT_DIR"
          
          New-Item -ItemType Directory -Force -Path $ARTIFACT_DIR | Out-Null
          
          Write-Host ""
          Write-Host "Copying all native binaries and supporting files..."
          Copy-Item -Path "$BIN_PATH\*" -Destination $ARTIFACT_DIR -Force
          
          $FILE_COUNT = (Get-ChildItem -Path $ARTIFACT_DIR).Count
          Write-Host "Copied $FILE_COUNT files"
          
          $BUILD_INFO = @"
          ======================================
          Hadoop Native Windows Build Information
          ======================================
          
          Hadoop Version: $HADOOP_VERSION
          Build Date: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
          Build Type: Native Windows Libraries (hadoop-common-project)
          Build OS: Windows Server 2022
          Build Runner: GitHub Actions
          Workflow: ${{ github.workflow }}
          Run Number: ${{ github.run_number }}
          
          Build Tools:
          - Java: $(java -version 2>&1 | Select-Object -First 1)
          - Maven: $(mvn --version | Select-Object -First 1)
          - CMake: $(cmake --version | Select-Object -First 1)
          - Protobuf: $(protoc --version)
          - Visual Studio: 2022 (Build Tools)
          
          ======================================
          What's Included
          ======================================
          
          This archive contains the native Windows binaries for Hadoop $HADOOP_VERSION:
          
          CORE BINARIES:
          - winutils.exe       : Windows utilities for Hadoop
          - hadoop.dll         : Core Hadoop native library
          - hadoop.lib/.pdb    : Import library and debug symbols
          - libwinutils.lib    : Windows utilities library
          
          HDFS BINARIES (if built):
          - hdfs.dll/.lib/.pdb : HDFS native library and symbols
          
          COMMAND SCRIPTS:
          - hadoop.cmd         : Hadoop command wrapper
          - hdfs.cmd          : HDFS command wrapper  
          - yarn.cmd          : YARN command wrapper
          - mapred.cmd        : MapReduce command wrapper
          
          SHELL SCRIPTS (for Git Bash/Cygwin):
          - hadoop, hdfs, yarn, mapred : Unix-style command scripts
          
          TEST LIBRARIES:
          - gtest*.pdb, gmock*.pdb : Google Test debug symbols
          
          ======================================
          Installation Instructions
          ======================================
          
          1. DOWNLOAD HADOOP DISTRIBUTION:
             Download the official Hadoop $HADOOP_VERSION binary distribution from:
             https://hadoop.apache.org/releases.html
             
          2. EXTRACT HADOOP:
             Extract the downloaded Hadoop distribution to a directory, e.g.:
             C:\hadoop-$HADOOP_VERSION
             
          3. INSTALL NATIVE BINARIES:
             Extract ALL files from this archive to:
             C:\hadoop-$HADOOP_VERSION\bin\
             
             This will add/replace the Windows native binaries.
             
          4. SET ENVIRONMENT VARIABLES:
             - HADOOP_HOME=C:\hadoop-$HADOOP_VERSION
             - Add %HADOOP_HOME%\bin to your PATH
             
          5. VERIFY INSTALLATION:
             Open a new command prompt and run:
             hadoop checknative -a
             
             You should see output showing native libraries are loaded.
          
          ======================================
          Troubleshooting
          ======================================
          
          If you get "Could not locate Hadoop executable":
          - Verify HADOOP_HOME is set correctly
          - Verify %HADOOP_HOME%\bin is in PATH
          - Restart your command prompt
          
          If you get "winutils.exe not found":
          - Verify winutils.exe is in %HADOOP_HOME%\bin
          - Check file permissions
          
          If native libraries fail to load:
          - Ensure you have Visual C++ Redistributable installed
          - Check that hadoop.dll is in %HADOOP_HOME%\bin
          
          ======================================
          Files Included in This Archive
          ======================================
          
          "@ | Out-File -FilePath "$ARTIFACT_DIR\BUILD_INFO.txt" -Encoding UTF8
          
          Write-Host ""
          Write-Host "Generating file manifest..."
          $TOTAL_SIZE = 0
          Get-ChildItem -Path $ARTIFACT_DIR | Sort-Object Name | ForEach-Object {
            $size = $_.Length
            $TOTAL_SIZE += $size
            
            $sizeStr = if ($size -lt 1KB) { 
              "$size bytes" 
            } elseif ($size -lt 1MB) { 
              "{0:N2} KB" -f ($size / 1KB) 
            } else { 
              "{0:N2} MB" -f ($size / 1MB) 
            }
            
            $line = "  - {0,-30} {1,15}" -f $_.Name, $sizeStr
            Add-Content -Path "$ARTIFACT_DIR\BUILD_INFO.txt" -Value $line
            Write-Host $line
          }
          
          $totalSizeStr = if ($TOTAL_SIZE -lt 1MB) { 
            "{0:N2} KB" -f ($TOTAL_SIZE / 1KB) 
          } else { 
            "{0:N2} MB" -f ($TOTAL_SIZE / 1MB) 
          }
          
          $summary = "`n  TOTAL: $FILE_COUNT files, $totalSizeStr"
          Add-Content -Path "$ARTIFACT_DIR\BUILD_INFO.txt" -Value $summary
          Add-Content -Path "$ARTIFACT_DIR\BUILD_INFO.txt" -Value "`n======================================"
          Add-Content -Path "$ARTIFACT_DIR\BUILD_INFO.txt" -Value "Build completed successfully!"
          Add-Content -Path "$ARTIFACT_DIR\BUILD_INFO.txt" -Value "======================================"
          
          Write-Host ""
          Write-Host "Artifacts prepared successfully!"
          Write-Host $summary

      # ============================================
      # STEP 15: Upload Native Binaries as Artifacts
      # ============================================
      - name: Upload Native Binaries
        uses: actions/upload-artifact@v4
        with:
          name: hadoop-${{ matrix.hadoop_version }}-native-windows-x64
          path: hadoop-artifacts/hadoop-${{ matrix.hadoop_version }}-native-win/
          if-no-files-found: error
          retention-days: 90
          compression-level: 9

      # ============================================
      # STEP 16: Upload Build Logs (on failure)
      # ============================================
      - name: Upload Build Logs on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.hadoop_version }}-${{ github.run_number }}
          path: |
            hadoop/hadoop-common-project/**/*.log
            hadoop/hadoop-common-project/**/target/surefire-reports/
          if-no-files-found: warn
          retention-days: 30

  # ============================================
  # Summary Job (runs after all builds complete)
  # ============================================
  build-summary:
    name: Build Summary
    needs: [prepare-matrix, build-hadoop]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate Build Summary
        run: |
          echo "# Hadoop Windows Native Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## What Was Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow builds **only the native Windows binaries** from Hadoop:" >> $GITHUB_STEP_SUMMARY
          echo "- \`winutils.exe\` - Hadoop Windows utilities" >> $GITHUB_STEP_SUMMARY
          echo "- \`hadoop.dll\` - Native Hadoop library" >> $GITHUB_STEP_SUMMARY
          echo "- Supporting files (\`.lib\`, \`.pdb\`, \`.exp\`)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "These binaries are built from the \`hadoop-common-project\` module only." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Hadoop Version | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Multiple versions | Check individual job logs |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Native Windows binaries have been uploaded as workflow artifacts." >> $GITHUB_STEP_SUMMARY
          echo "Download them from the [Actions artifacts section](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Usage Instructions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the official Hadoop distribution for your version from [Apache Hadoop](https://hadoop.apache.org/releases.html)" >> $GITHUB_STEP_SUMMARY
          echo "2. Download the native binaries artifact for your version from this workflow" >> $GITHUB_STEP_SUMMARY
          echo "3. Extract the native binaries to \`HADOOP_HOME\\bin\` directory" >> $GITHUB_STEP_SUMMARY
          echo "4. Set \`HADOOP_HOME\` environment variable to your Hadoop installation directory" >> $GITHUB_STEP_SUMMARY
          echo "5. Add \`%HADOOP_HOME%\\bin\` to your system PATH" >> $GITHUB_STEP_SUMMARY
          echo "6. Verify with: \`hadoop checknative -a\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Why Only Native Binaries?" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Building the full Hadoop distribution on Windows requires WSL (Windows Subsystem for Linux)," >> $GITHUB_STEP_SUMMARY
          echo "which is not available in GitHub Actions runners. Since the native binaries are the main" >> $GITHUB_STEP_SUMMARY
          echo "components missing from the official distributions, we build only those components." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The native binaries are fully compatible with the official Hadoop distributions." >> $GITHUB_STEP_SUMMARY
