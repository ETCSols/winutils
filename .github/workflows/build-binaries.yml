name: Build Hadoop Native Libraries for Windows

on:
  # Allow manual trigger with version selection
  workflow_dispatch:
    inputs:
      hadoop_versions:
        description: 'Hadoop versions to build (comma-separated, e.g., 3.3.6,3.4.1,3.4.2)'
        required: true
        default: '3.4.2'
  
  # # Trigger on push to main branch (optional)
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - '.github/workflows/build-hadoop-windows.yml'
  
  # # Scheduled builds (optional - runs monthly)
  # schedule:
  #   - cron: '0 0 1 * *'  # First day of every month

env:
  # Build configuration
  MAVEN_OPTS: '-Xms512m -Xmx2048m'
  JAVA_HOME_VAR: 'JAVA_HOME_11_X64'  # GitHub Actions Java 11 path variable

jobs:
  # Job to prepare the build matrix from input or default versions
  prepare-matrix:
    name: Prepare Build Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set Matrix Versions
        id: set-matrix
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Use input versions from manual trigger
            VERSIONS="${{ github.event.inputs.hadoop_versions }}"
          else
            # Default versions for scheduled or push events
            VERSIONS="3.3.6,3.4.1,3.4.2"
          fi
          
          # Convert comma-separated string to JSON array
          MATRIX=$(echo $VERSIONS | jq -R -c 'split(",") | map(gsub("^\\s+|\\s+$";""))')
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "Building Hadoop versions: $MATRIX"

  # Main build job with matrix strategy
  build-hadoop:
    name: Build Hadoop ${{ matrix.hadoop_version }}
    needs: prepare-matrix
    runs-on: windows-2022  # Using windows-2022 (windows-2019 retired as of 2025-06-30)
    strategy:
      fail-fast: false  # Continue other builds even if one fails
      matrix:
        hadoop_version: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
    
    steps:
      # ============================================
      # STEP 1: Checkout repository (for workflow tracking)
      # ============================================
      - name: Checkout Artifact Repository
        uses: actions/checkout@v4

      # ============================================
      # STEP 2: Setup Java Environment
      # ============================================
      - name: Setup Java JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Verify Java Installation
        shell: cmd
        run: |
          echo Verifying Java installation...
          java -version
          echo JAVA_HOME=%JAVA_HOME%

      # ============================================
      # STEP 3: Setup Maven
      # ============================================
      - name: Verify Maven Installation
        shell: cmd
        run: |
          echo Verifying Maven installation...
          mvn --version

      # ============================================
      # STEP 4: Setup CMake (required for native builds)
      # ============================================
      - name: Setup CMake
        uses: lukka/get-cmake@latest
        with:
          cmakeVersion: '3.28.0'

      - name: Verify CMake Installation
        shell: cmd
        run: |
          echo Verifying CMake installation...
          cmake --version

      # ============================================
      # STEP 5: Setup Protocol Buffers
      # ============================================
      - name: Setup Protocol Buffers 21.12
        shell: powershell
        run: |
          Write-Host "Installing Protocol Buffers 21.12..."
          
          # Protocol Buffers version (using new versioning scheme: v21.12 instead of v3.21.12)
          $PROTOBUF_VERSION = "21.12"
          $PROTOBUF_URL = "https://github.com/protocolbuffers/protobuf/releases/download/v$PROTOBUF_VERSION/protoc-$PROTOBUF_VERSION-win64.zip"
          
          # Create temp directory
          $TEMP_DIR = "$env:TEMP\protobuf"
          New-Item -ItemType Directory -Force -Path $TEMP_DIR | Out-Null
          
          # Download and extract
          $ZIP_FILE = "$TEMP_DIR\protoc.zip"
          Write-Host "Downloading from $PROTOBUF_URL..."
          Invoke-WebRequest -Uri $PROTOBUF_URL -OutFile $ZIP_FILE -UseBasicParsing
          
          # Extract to C:\protobuf
          $PROTOBUF_HOME = "C:\protobuf"
          Write-Host "Extracting to $PROTOBUF_HOME..."
          Expand-Archive -Path $ZIP_FILE -DestinationPath $PROTOBUF_HOME -Force
          
          # Add to PATH for subsequent steps
          echo "$PROTOBUF_HOME\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          
          Write-Host "Protocol Buffers installed successfully"

      - name: Verify Protocol Buffers Installation
        shell: cmd
        run: |
          echo Verifying Protocol Buffers installation...
          protoc --version

      # ============================================
      # STEP 6: Setup Boost (using vcpkg for Windows)
      # ============================================
      - name: Setup Boost 1.86.0
        shell: powershell
        run: |
          Write-Host "Installing Boost via vcpkg..."
          
          # vcpkg comes pre-installed on GitHub runners
          vcpkg install boost:x64-windows
          
          # Set BOOST_ROOT environment variable
          $BOOST_ROOT = "C:\vcpkg\installed\x64-windows"
          echo "BOOST_ROOT=$BOOST_ROOT" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          
          Write-Host "Boost installed successfully"

      # ============================================
      # STEP 7: Setup Zlib (required for compression)
      # ============================================
      - name: Setup Zlib
        shell: powershell
        run: |
          Write-Host "Installing Zlib via vcpkg..."
          
          vcpkg install zlib:x64-windows
          
          # Set ZLIB_HOME environment variable
          $ZLIB_HOME = "C:\vcpkg\installed\x64-windows"
          echo "ZLIB_HOME=$ZLIB_HOME" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          
          Write-Host "Zlib installed successfully"

      # ============================================
      # STEP 8: Setup Visual Studio Environment
      # ============================================
      - name: Setup Visual Studio Build Environment
        uses: microsoft/setup-msbuild@v2
        with:
          vs-version: '[17.0,18.0)'  # Visual Studio 2022
          
      - name: Setup Visual Studio Developer Command Prompt
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # ============================================
      # STEP 9: Set Platform Environment Variable
      # ============================================
      - name: Set Platform Environment Variable
        shell: cmd
        run: |
          echo Setting Platform environment variable for 64-bit build...
          echo Platform=x64>> %GITHUB_ENV%

      # ============================================
      # STEP 10: Clone Hadoop Repository
      # ============================================
      - name: Enable Git Long Paths
        shell: cmd
        run: |
          echo Enabling Git long path support for Windows...
          git config --global core.longpaths true
          
      - name: Clone Hadoop Repository
        shell: cmd
        run: |
          echo Cloning Apache Hadoop repository...
          git clone https://gitbox.apache.org/repos/asf/hadoop.git hadoop
          
      - name: Checkout Hadoop Version Tag
        shell: cmd
        working-directory: hadoop
        run: |
          echo Checking out Hadoop version ${{ matrix.hadoop_version }}...
          git fetch --tags
          git checkout rel/release-${{ matrix.hadoop_version }}
          
      - name: Verify Hadoop Source
        shell: cmd
        working-directory: hadoop
        run: |
          echo Verifying Hadoop source checkout...
          echo Current working directory:
          cd
          echo.
          echo Current branch/tag:
          git describe --tags
          echo.
          echo Latest commit:
          git log -1 --oneline
          echo.
          echo Source directory contents:
          dir

      # ============================================
      # STEP 11A: Verify Maven Profile Configuration
      # ============================================
      - name: Check Maven Native Profile
        shell: cmd
        working-directory: hadoop\hadoop-common-project\hadoop-common
        run: |
          echo ================================================
          echo Checking Maven Profile Configuration
          echo ================================================
          
          echo Listing available Maven profiles...
          mvn help:all-profiles
          
          echo.
          echo Checking if native-win profile exists...
          mvn help:active-profiles -Pnative-win
          
          echo.
          echo Checking effective POM with native-win profile...
          mvn help:effective-pom -Pnative-win > effective-pom.xml
          
          echo.
          echo Searching for native build configuration in effective POM...
          findstr /I /C:"native" /C:"cmake" /C:"make" effective-pom.xml
          
          echo.
          echo Checking what Maven will execute with native-win profile...
          mvn compile -Pnative-win -DskipTests -X -Dmaven.javadoc.skip=true 2>&1 | findstr /I /C:"native" /C:"cmake" /C:"exec" /C:"BUILD SUCCESS" /C:"BUILD FAILURE"

      # ============================================
      # STEP 11B: Cache Maven Dependencies
      # ============================================
      - name: Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ runner.os }}-${{ matrix.hadoop_version }}-${{ hashFiles('hadoop/**/pom.xml') }}
          restore-keys: |
            maven-${{ runner.os }}-${{ matrix.hadoop_version }}-
            maven-${{ runner.os }}-

      # ============================================
      # STEP 12: Build Hadoop Native Libraries
      # ============================================
      - name: Build Hadoop Common Native Libraries
        shell: cmd
        working-directory: hadoop\hadoop-common-project\hadoop-common
        run: |
          echo ================================================
          echo Building Hadoop ${{ matrix.hadoop_version }} Native Libraries
          echo ================================================
          echo Current directory: %CD%
          echo.
          
          REM Set required environment variables for native build
          set JAVA_HOME=%JAVA_HOME%
          set PATH=%PATH%;C:\protobuf\bin
          set REQUIRE_SNAPPY=false
          set REQUIRE_OPENSSL=false
          set REQUIRE_BZIP2=false
          
          REM Display environment for debugging
          echo Environment Variables:
          echo JAVA_HOME=%JAVA_HOME%
          echo MAVEN_OPTS=%MAVEN_OPTS%
          echo Platform=%Platform%
          echo REQUIRE_SNAPPY=%REQUIRE_SNAPPY%
          echo.
          
          REM Verify tools are available
          echo Verifying build tools...
          java -version
          if errorlevel 1 (
            echo ERROR: Java not found!
            exit /b 1
          )
          echo.
          
          mvn --version
          if errorlevel 1 (
            echo ERROR: Maven not found!
            exit /b 1
          )
          echo.
          
          cmake --version
          if errorlevel 1 (
            echo ERROR: CMake not found!
            exit /b 1
          )
          echo.
          
          protoc --version
          if errorlevel 1 (
            echo ERROR: Protoc not found!
            exit /b 1
          )
          echo.
          
          msbuild /version
          if errorlevel 1 (
            echo ERROR: MSBuild not found!
            exit /b 1
          )
          echo.
          
          REM Check Visual Studio environment
          echo Checking Visual Studio environment...
          echo VCINSTALLDIR=%VCINSTALLDIR%
          echo VCToolsInstallDir=%VCToolsInstallDir%
          if "%VCINSTALLDIR%"=="" (
            echo WARNING: VCINSTALLDIR not set - Visual Studio environment may not be configured
          )
          echo.
          
          REM Verify pom.xml exists
          if not exist pom.xml (
            echo ERROR: pom.xml not found in current directory!
            echo Current directory: %CD%
            dir
            exit /b 1
          )
          
          echo ================================================
          echo Starting Maven build with native profile
          echo ================================================
          echo.
          echo Build command:
          echo mvn clean install -Pnative-win -DskipTests -Dmaven.javadoc.skip=true -Drequire.snappy=false -Drequire.openssl=false -e
          echo.
          
          REM Execute Maven build with verbose error output
          REM -Pnative-win: Activates Windows native build profile
          REM -DskipTests: Skip running tests
          REM -Dmaven.javadoc.skip: Skip javadoc generation
          REM -Drequire.snappy=false: Don't require Snappy (optional compression)
          REM -Drequire.openssl=false: Don't require OpenSSL
          REM -e: Show detailed error messages
          
          mvn clean install -Pnative-win -DskipTests -Dmaven.javadoc.skip=true -Drequire.snappy=false -Drequire.openssl=false -e
          
          set BUILD_EXIT_CODE=%ERRORLEVEL%
          
          echo.
          echo ================================================
          echo Maven build exit code: %BUILD_EXIT_CODE%
          echo ================================================
          echo.
          
          if %BUILD_EXIT_CODE% neq 0 (
            echo ERROR: Maven build failed with exit code %BUILD_EXIT_CODE%
            echo.
            echo Checking what was created in target directory...
            if exist target (
              echo Target directory exists. Contents:
              dir target
            ) else (
              echo Target directory does not exist!
            )
            exit /b %BUILD_EXIT_CODE%
          )
          
          echo Maven build completed successfully!
          echo.
          
          REM Verify target directory was created
          if not exist target (
            echo ERROR: Target directory was not created despite successful build!
            exit /b 1
          )
          
          echo ================================================
          echo Examining build output
          echo ================================================
          echo.
          
          echo Listing target directory contents...
          dir target
          echo.
          
          echo Listing target subdirectories...
          dir /ad target
          echo.
          
          REM Check for native directory and its contents
          if exist target\native (
            echo [OK] Native directory found: target\native
            echo.
            echo Contents of target\native:
            dir target\native
            echo.
            
            if exist target\native\target (
              echo [OK] Native target subdirectory found: target\native\target
              echo.
              echo Contents of target\native\target:
              dir target\native\target
              echo.
              
              if exist target\native\target\bin (
                echo [OK] Native bin directory found: target\native\target\bin
                echo.
                echo Contents of target\native\target\bin:
                dir target\native\target\bin
              ) else (
                echo [WARNING] target\native\target\bin does not exist
                echo.
                echo Searching for bin directories in native folder...
                dir /s /ad target\native\*bin*
              )
            ) else (
              echo [WARNING] target\native\target does not exist
              echo.
              echo Contents of target\native:
              dir /s target\native
            )
          ) else (
            echo [ERROR] target\native directory does not exist!
            echo This means the native build was skipped or failed.
            echo.
            echo Searching entire target directory for any compiled binaries...
            dir /s /b target\*.exe target\*.dll 2>nul
            echo.
            echo If no files found above, native compilation did not run.
            exit /b 1
          )
        timeout-minutes: 60
        continue-on-error: false

      # ============================================
      # STEP 13: Verify Build Artifacts
      # ============================================
      - name: Check Build Logs for Native Compilation
        shell: powershell
        working-directory: hadoop
        run: |
          Write-Host "Checking if native compilation was attempted..."
          
          # Look for CMake execution in recent files
          Write-Host ""
          Write-Host "Searching for CMake-related files..."
          Get-ChildItem -Path "hadoop-common-project\hadoop-common" -Recurse -Filter "CMakeCache.txt" -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Host "  Found: $($_.FullName)"
          }
          
          Write-Host ""
          Write-Host "Searching for build directories..."
          Get-ChildItem -Path "hadoop-common-project\hadoop-common\target" -Directory -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Host "  - $($_.Name)"
          }
          
          Write-Host ""
          Write-Host "Checking for any compiled files..."
          Get-ChildItem -Path "hadoop-common-project\hadoop-common\target" -Recurse -Include "*.exe","*.dll","*.lib" -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Host "  Found: $($_.FullName) ($($_.Length) bytes)"
          }
          
      - name: Verify Native Binaries
        shell: powershell
        working-directory: hadoop
        run: |
          Write-Host "Verifying native binaries were built..."
          
          # Try multiple possible locations
          $POSSIBLE_PATHS = @(
            "hadoop-common-project\hadoop-common\target\native\target\bin",
            "hadoop-common-project\hadoop-common\target\bin",
            "hadoop-common-project\hadoop-common\src\main\native\target\bin",
            "hadoop-common-project\hadoop-common\target\native\bin"
          )
          
          $NATIVE_PATH = $null
          foreach ($path in $POSSIBLE_PATHS) {
            if (Test-Path $path) {
              $NATIVE_PATH = $path
              Write-Host "Found native bin directory at: $path"
              break
            }
          }
          
          if (-not $NATIVE_PATH) {
            Write-Host ""
            Write-Host "ERROR: Could not find native bin directory in any expected location!"
            Write-Host ""
            Write-Host "Searched locations:"
            foreach ($path in $POSSIBLE_PATHS) {
              Write-Host "  - $path"
            }
            
            Write-Host ""
            Write-Host "Available directories in target:"
            Get-ChildItem -Path "hadoop-common-project\hadoop-common\target" -Directory -ErrorAction SilentlyContinue | ForEach-Object {
              Write-Host "  - target\$($_.Name)"
            }
            
            exit 1
          }
          
          Write-Host "Checking binaries in: $NATIVE_PATH"
          Write-Host "Full path: $((Get-Location).Path)\$NATIVE_PATH"
          
          $REQUIRED_FILES = @(
            "winutils.exe",
            "winutils.pdb",
            "hadoop.dll",
            "hadoop.exp",
            "hadoop.lib",
            "hadoop.pdb",
            "hadoop.cmd",
            "libwinutils.lib",
            "libwinutils.pdb"
          )
          
          $OPTIONAL_FILES = @(
            "hdfs.dll",
            "hdfs.exp",
            "hdfs.lib",
            "hdfs.pdb",
            "hdfs.cmd",
            "mapred.cmd",
            "yarn.cmd",
            "hdfs",
            "mapred",
            "yarn",
            "hadoop",
            "gmock.pdb",
            "gmock_main.pdb",
            "gtest.pdb",
            "gtest_main.pdb"
          )
          
          $ALL_FOUND = $true
          $FOUND_COUNT = 0
          
          Write-Host ""
          Write-Host "=== CRITICAL NATIVE FILES ==="
          foreach ($FILE in $REQUIRED_FILES) {
            $FILE_PATH = Join-Path $NATIVE_PATH $FILE
            if (Test-Path $FILE_PATH) {
              $FILE_SIZE = (Get-Item $FILE_PATH).Length
              Write-Host "  [OK] Found: $FILE ($FILE_SIZE bytes)"
              $FOUND_COUNT++
            } else {
              Write-Host "  [MISSING] $FILE"
              $ALL_FOUND = $false
            }
          }
          
          Write-Host ""
          Write-Host "=== OPTIONAL/ADDITIONAL FILES ==="
          foreach ($FILE in $OPTIONAL_FILES) {
            $FILE_PATH = Join-Path $NATIVE_PATH $FILE
            if (Test-Path $FILE_PATH) {
              $FILE_SIZE = (Get-Item $FILE_PATH).Length
              Write-Host "  [OK] Found: $FILE ($FILE_SIZE bytes)"
              $FOUND_COUNT++
            } else {
              Write-Host "  [SKIP] Not found: $FILE (optional)"
            }
          }
          
          if (-not $ALL_FOUND) {
            Write-Host ""
            Write-Host "ERROR: Some REQUIRED binaries were not built!"
            Write-Host ""
            Write-Host "Searching entire target directory for native binaries..."
            
            Write-Host ""
            Write-Host "DLL files found:"
            Get-ChildItem -Path "hadoop-common-project" -Recurse -Filter "*.dll" -ErrorAction SilentlyContinue | ForEach-Object {
              Write-Host "  - $($_.FullName)"
            }
            
            Write-Host ""
            Write-Host "EXE files found:"
            Get-ChildItem -Path "hadoop-common-project" -Recurse -Filter "*.exe" -ErrorAction SilentlyContinue | ForEach-Object {
              Write-Host "  - $($_.FullName)"
            }
            
            Write-Host ""
            Write-Host "LIB files found:"
            Get-ChildItem -Path "hadoop-common-project" -Recurse -Filter "*.lib" -ErrorAction SilentlyContinue | ForEach-Object {
              Write-Host "  - $($_.FullName)"
            }
            
            exit 1
          }
          
          Write-Host ""
          Write-Host "SUCCESS: All REQUIRED native binaries found!"
          Write-Host "Total files found: $FOUND_COUNT"
          
          Write-Host ""
          Write-Host "=== ALL FILES IN NATIVE BIN DIRECTORY ==="
          Get-ChildItem -Path $NATIVE_PATH | Sort-Object Name | ForEach-Object {
            $size = if ($_.Length -lt 1KB) { 
              "$($_.Length) bytes" 
            } elseif ($_.Length -lt 1MB) { 
              "{0:N2} KB" -f ($_.Length / 1KB) 
            } else { 
              "{0:N2} MB" -f ($_.Length / 1MB) 
            }
            Write-Host "  - $($_.Name) ($size)"
          }

      # ============================================
      # STEP 14: Prepare Artifacts for Upload
      # ============================================
      - name: Prepare Artifacts
        shell: powershell
        working-directory: hadoop
        run: |
          Write-Host "Preparing artifacts for upload..."
          
          $HADOOP_VERSION = "${{ matrix.hadoop_version }}"
          $BIN_PATH = "hadoop-common-project\hadoop-common\target\native\target\bin"
          $ARTIFACT_DIR = "..\hadoop-artifacts\hadoop-$HADOOP_VERSION-native-win"
          
          Write-Host "Source path: $((Get-Location).Path)\$BIN_PATH"
          Write-Host "Destination path: $((Get-Location).Path)\$ARTIFACT_DIR"
          
          New-Item -ItemType Directory -Force -Path $ARTIFACT_DIR | Out-Null
          
          Write-Host ""
          Write-Host "Copying all native binaries and supporting files..."
          Copy-Item -Path "$BIN_PATH\*" -Destination $ARTIFACT_DIR -Force
          
          $FILE_COUNT = (Get-ChildItem -Path $ARTIFACT_DIR).Count
          Write-Host "Copied $FILE_COUNT files"
          
          $BUILD_INFO = @"
          ======================================
          Hadoop Native Windows Build Information
          ======================================
          
          Hadoop Version: $HADOOP_VERSION
          Build Date: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
          Build Type: Native Windows Libraries (hadoop-common-project)
          Build OS: Windows Server 2022
          Build Runner: GitHub Actions
          Workflow: ${{ github.workflow }}
          Run Number: ${{ github.run_number }}
          
          Build Tools:
          - Java: $(java -version 2>&1 | Select-Object -First 1)
          - Maven: $(mvn --version | Select-Object -First 1)
          - CMake: $(cmake --version | Select-Object -First 1)
          - Protobuf: $(protoc --version)
          - Visual Studio: 2022 (Build Tools)
          
          ======================================
          What's Included
          ======================================
          
          This archive contains the native Windows binaries for Hadoop $HADOOP_VERSION:
          
          CORE BINARIES:
          - winutils.exe       : Windows utilities for Hadoop
          - hadoop.dll         : Core Hadoop native library
          - hadoop.lib/.pdb    : Import library and debug symbols
          - libwinutils.lib    : Windows utilities library
          
          HDFS BINARIES (if built):
          - hdfs.dll/.lib/.pdb : HDFS native library and symbols
          
          COMMAND SCRIPTS:
          - hadoop.cmd         : Hadoop command wrapper
          - hdfs.cmd          : HDFS command wrapper  
          - yarn.cmd          : YARN command wrapper
          - mapred.cmd        : MapReduce command wrapper
          
          SHELL SCRIPTS (for Git Bash/Cygwin):
          - hadoop, hdfs, yarn, mapred : Unix-style command scripts
          
          TEST LIBRARIES:
          - gtest*.pdb, gmock*.pdb : Google Test debug symbols
          
          ======================================
          Installation Instructions
          ======================================
          
          1. DOWNLOAD HADOOP DISTRIBUTION:
             Download the official Hadoop $HADOOP_VERSION binary distribution from:
             https://hadoop.apache.org/releases.html
             
          2. EXTRACT HADOOP:
             Extract the downloaded Hadoop distribution to a directory, e.g.:
             C:\hadoop-$HADOOP_VERSION
             
          3. INSTALL NATIVE BINARIES:
             Extract ALL files from this archive to:
             C:\hadoop-$HADOOP_VERSION\bin\
             
             This will add/replace the Windows native binaries.
             
          4. SET ENVIRONMENT VARIABLES:
             - HADOOP_HOME=C:\hadoop-$HADOOP_VERSION
             - Add %HADOOP_HOME%\bin to your PATH
             
          5. VERIFY INSTALLATION:
             Open a new command prompt and run:
             hadoop checknative -a
             
             You should see output showing native libraries are loaded.
          
          ======================================
          Troubleshooting
          ======================================
          
          If you get "Could not locate Hadoop executable":
          - Verify HADOOP_HOME is set correctly
          - Verify %HADOOP_HOME%\bin is in PATH
          - Restart your command prompt
          
          If you get "winutils.exe not found":
          - Verify winutils.exe is in %HADOOP_HOME%\bin
          - Check file permissions
          
          If native libraries fail to load:
          - Ensure you have Visual C++ Redistributable installed
          - Check that hadoop.dll is in %HADOOP_HOME%\bin
          
          ======================================
          Files Included in This Archive
          ======================================
          
          "@ | Out-File -FilePath "$ARTIFACT_DIR\BUILD_INFO.txt" -Encoding UTF8
          
          Write-Host ""
          Write-Host "Generating file manifest..."
          $TOTAL_SIZE = 0
          Get-ChildItem -Path $ARTIFACT_DIR | Sort-Object Name | ForEach-Object {
            $size = $_.Length
            $TOTAL_SIZE += $size
            
            $sizeStr = if ($size -lt 1KB) { 
              "$size bytes" 
            } elseif ($size -lt 1MB) { 
              "{0:N2} KB" -f ($size / 1KB) 
            } else { 
              "{0:N2} MB" -f ($size / 1MB) 
            }
            
            $line = "  - {0,-30} {1,15}" -f $_.Name, $sizeStr
            Add-Content -Path "$ARTIFACT_DIR\BUILD_INFO.txt" -Value $line
            Write-Host $line
          }
          
          $totalSizeStr = if ($TOTAL_SIZE -lt 1MB) { 
            "{0:N2} KB" -f ($TOTAL_SIZE / 1KB) 
          } else { 
            "{0:N2} MB" -f ($TOTAL_SIZE / 1MB) 
          }
          
          $summary = "`n  TOTAL: $FILE_COUNT files, $totalSizeStr"
          Add-Content -Path "$ARTIFACT_DIR\BUILD_INFO.txt" -Value $summary
          Add-Content -Path "$ARTIFACT_DIR\BUILD_INFO.txt" -Value "`n======================================"
          Add-Content -Path "$ARTIFACT_DIR\BUILD_INFO.txt" -Value "Build completed successfully!"
          Add-Content -Path "$ARTIFACT_DIR\BUILD_INFO.txt" -Value "======================================"
          
          Write-Host ""
          Write-Host "Artifacts prepared successfully!"
          Write-Host $summary

      # ============================================
      # STEP 15: Upload Native Binaries as Artifacts
      # ============================================
      - name: Upload Native Binaries
        uses: actions/upload-artifact@v4
        with:
          name: hadoop-${{ matrix.hadoop_version }}-native-windows-x64
          path: hadoop-artifacts/hadoop-${{ matrix.hadoop_version }}-native-win/
          if-no-files-found: error
          retention-days: 90
          compression-level: 9

      # ============================================
      # STEP 16: Upload Build Logs (on failure)
      # ============================================
      - name: Upload Build Logs on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.hadoop_version }}-${{ github.run_number }}
          path: |
            hadoop/hadoop-common-project/**/*.log
            hadoop/hadoop-common-project/**/target/surefire-reports/
          if-no-files-found: warn
          retention-days: 30

  # ============================================
  # Summary Job (runs after all builds complete)
  # ============================================
  build-summary:
    name: Build Summary
    needs: [prepare-matrix, build-hadoop]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate Build Summary
        run: |
          echo "# Hadoop Windows Native Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## What Was Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow builds **only the native Windows binaries** from Hadoop:" >> $GITHUB_STEP_SUMMARY
          echo "- \`winutils.exe\` - Hadoop Windows utilities" >> $GITHUB_STEP_SUMMARY
          echo "- \`hadoop.dll\` - Native Hadoop library" >> $GITHUB_STEP_SUMMARY
          echo "- Supporting files (\`.lib\`, \`.pdb\`, \`.exp\`)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "These binaries are built from the \`hadoop-common-project\` module only." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Hadoop Version | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Multiple versions | Check individual job logs |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Native Windows binaries have been uploaded as workflow artifacts." >> $GITHUB_STEP_SUMMARY
          echo "Download them from the [Actions artifacts section](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Usage Instructions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the official Hadoop distribution for your version from [Apache Hadoop](https://hadoop.apache.org/releases.html)" >> $GITHUB_STEP_SUMMARY
          echo "2. Download the native binaries artifact for your version from this workflow" >> $GITHUB_STEP_SUMMARY
          echo "3. Extract the native binaries to \`HADOOP_HOME\\bin\` directory" >> $GITHUB_STEP_SUMMARY
          echo "4. Set \`HADOOP_HOME\` environment variable to your Hadoop installation directory" >> $GITHUB_STEP_SUMMARY
          echo "5. Add \`%HADOOP_HOME%\\bin\` to your system PATH" >> $GITHUB_STEP_SUMMARY
          echo "6. Verify with: \`hadoop checknative -a\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Why Only Native Binaries?" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Building the full Hadoop distribution on Windows requires WSL (Windows Subsystem for Linux)," >> $GITHUB_STEP_SUMMARY
          echo "which is not available in GitHub Actions runners. Since the native binaries are the main" >> $GITHUB_STEP_SUMMARY
          echo "components missing from the official distributions, we build only those components." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The native binaries are fully compatible with the official Hadoop distributions." >> $GITHUB_STEP_SUMMARY
